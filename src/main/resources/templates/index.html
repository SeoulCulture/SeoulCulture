<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/index-header :: header"/>
<body>
    <div id="loading" style="display: none;">
        <img src='https://tistory2.daumcdn.net/tistory/1898109/skin/images/Spinner.gif' style='position: relative; display: block; margin: 0px auto;'/>
    </div>
    <div id="main-title">
        <!-- <h2>서울 지금 여기</h2> -->
            <h3>서울 지금 여기</h3>
            <br>
            <h3>Seoul, Now, Here</h3>
    </div>

    <main class="mainContents">
        <div id="inputContainer">
            <form id="form" role="form" action="/culture/search" th:object="${cultureForm}", method="get">
                <table>
                    <tbody>
                    <tr>
                        <td class="table-head"><label for="moods">지금 기분이 어떤가요?</label></td>
                    </tr>
                    <tr>
                        <td><input id="moods" class="mainInput" name="moods" th:field="*{moods}"></td>
                    </tr>
                    <br>
                    <tr>
                        <td class="table-head"><label for="time">어느정도 거리가 괜찮을까요?</label></td>
                    </tr>
                    <tr>
                        <td><input type="number" class="form-control mainInput normal-main-input" id="time" name="time" placeholder="" th:field="*{time}"></td>
                    </tr>
                    <tr>
                        <td>
                            <input type="radio" id="walking" class="mainInput" name="howToGo" value="WALKING" th:checked="${cultureForm.howToGo == 'WALKING'}">
                            <label for="walking">도보</label>
                            <input type="radio" id="driving" class="mainInput" name="howToGo" value="DRIVING" th:checked="${cultureForm.howToGo == 'DRIVING'}">
                            <label for="driving">차량</label>
                        </td>
                    </tr>
                    <tr>
                        <td class="table-head"><label for="price">비용은 어느정도가 좋을까요?</label></td>
                    </tr>
                    <tr>
                        <td><input type="number" class="form-control mainInput normal-main-input" id="price" name="price" placeholder="" th:field="*{price}"></td>
                    </tr>
                    <tr>
                        <td>무료 <input type="checkbox" id="free" class="mainInput" th:checked="${cultureForm.price == 0}"></td>
                    </tr>
                    <tr>
                        <td class="table-head">어디 주변으로 알아볼까요?</td>
                    </tr>
                    <tr>
                        <td><input type="text" id="searchInput" class="mainInput normal-main-input" name="spot" autocomplete="off"></td>
                    </tr>
                    <tr>
                        <td><div id="searchResults"></div></td>
                    </tr>
                    </tbody>
                </table>
                <div id="submit-button">
                    <button id="submitBtn" type="submit" class="btn btn-primary">Let's go!</button>
                </div>
            </form>

            <div id="spotInputBox">
<!--                <div>장소 지정하기</div>-->
<!--                <input type="text" id="searchInput" class="mainInput" name="spot" autocomplete="off">-->
<!--                <div id="searchResults"></div>-->
            </div>
        </div>
    </main>
<div id="searchStatus" style="display: none;">검색 중입니다...</div>
</body>
</html>


<!--검색 자동완성-->
<script>
    // 초성검색 설정

    // 초성검색 : https://gurtn.tistory.com/212
    // 초성배열
    const CHO_HANGUL = [
        'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ',
        'ㄹ', 'ㅁ', 'ㅂ','ㅃ', 'ㅅ',
        'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ',
        'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ',
    ];

    // 한글 시작 유니코드
    const HANGUL_START_CHARCODE = "가".charCodeAt();

    // 초성, 종성 주기
    const CHO_PERIOD = Math.floor("까".charCodeAt() - "가".charCodeAt());
    const JUNG_PERIOD = Math.floor("개".charCodeAt() - "가".charCodeAt());

    // 한글 결합 함수
    function combine(cho, jung, jong) {
        return String.fromCharCode(
            HANGUL_START_CHARCODE + cho * CHO_PERIOD + jung * JUNG_PERIOD + jong
        );
    }
    // 초성검색
    function makeRegexByCho(search = "") {
        const regex = CHO_HANGUL.reduce(
            (acc, cho, index) =>
                acc.replace(
                    new RegExp(cho, "g"),
                    `[${combine(index, 0, 0)}-${combine(index + 1, 0, -1)}]`
                ),
            search
        );

        return new RegExp(`(${regex})`, "g");
    }
    function includeByCho(search, targetWord) {
        return makeRegexByCho(search).test(targetWord);
    }

    // 검색
    const $searchInput = document.querySelector("#searchInput");
    let nowIndex = 0;
    const ignoreKey = [37, 38, 39, 40]
    let preMatched;
    let preInput;
    $( document ).ready( (event) => {
        $searchInput.onkeyup = (event) => {
            let input;
            let matches;
            if (ignoreKey.includes(event.keyCode)) {
                matches = preMatched;
                input = preInput;
            } else {
                input = document.getElementById('searchInput').value.trim();
                matches = findMatchingStrings(event, input);
                preMatched = matches;
                preInput = input;
            }
            handleUpDownIndex(event, matches);
            showSearchResult(matches, input);
        };
    });

    // 매칭된 검색 결과 리턴 & 정렬알고리즘(일치율 높은 내림차순)
    function findMatchingStrings(event, val) {
        const matches = [];
        const inputLength = val.length;
        spotDtos.forEach((spotDto) => {
            if (includeByCho(val, spotDto.spotName)) {
                const matchingChars = calculateMatchingChars(val, spotDto.spotName);
                const matchRate = (matchingChars / inputLength) * 100; // 일치율 계산
                matches.push({ name: spotDto.spotName, matchRate: matchRate }); // 일치율과 함께 추가
            }
        });
        matches.sort((a, b) => b.matchRate - a.matchRate);
        return matches.map(match => match.name);
    }
    function calculateMatchingChars(str1, str2) {
        let matchingChars = 0;
        const len = Math.min(str1.length, str2.length);
        for (let i = 0; i < len; i++) {
            if (str1[i] === str2[i]) {
                matchingChars++;
            }
        }
        return matchingChars;
    }


    function handleUpDownIndex(event, matches) {
        switch (event.keyCode) {
            // UP KEY
            case 38:
                nowIndex = Math.max(nowIndex - 1, 0);
                break;
            // DOWN KEY
            case 40:
                nowIndex = Math.min(nowIndex + 1, matches.length - 1);
                break;
            // ENTER KEY
            case 13:
                document.querySelector("#searchInput").value = matches[nowIndex] || "";
                // 초기화
                nowIndex = 0;
                matches.length = 0;
                break;
            // 그외 다시 초기화
            default:
                nowIndex = 0;
                break;
        }
    }

    const showSearchResult = (matches, input) => {
        const regex = makeRegexByCho(input);

        const searchResults = document.getElementById("searchResults");
        searchResults.innerHTML = matches
            .map(
                (label, index) => `
        <div class='${nowIndex === index ? "active" : ""}'>
          ${label.replace(regex, "<mark>$1</mark>")}
        </div>`).join("");
    };
</script>